{% extends "base.html" %}

{% block content %}
<h1>{% block title %}Address Book{% endblock title %}</h1>
<p>Below are all of the people in your address book. Not all of them are users on the site.</p>

<dl>
{% for contact in contacts %}
{% if contact.user.get_profile %}
	<dt id="contact-{{ contact.id }}">
	{# This is a user on the site, so display site user information #}
	{% if contact.user.get_profile.photo %}
		<a href="{{ contact.user.get_profile.get_absolute_url }}" /><img src="{{ MEDIA_URL }}/{{ contact.user.get_profile.photo.thumbnail.url }}" style="border: 0; float: middle;"  /></a>
	{% else %}
		<a href="{{ contact.user.get_profile.get_absolute_url }}" /><img src="{{ MEDIA_URL }}/images/unknown_thumbnail.png" style="border: 0; vertical-align: middle;" /></a>
	{% endif %} 
	<strong><a href="{{ contact.user.get_profile.get_absolute_url }}" />{% firstof contact.user.get_profile.user.get_full_name contact.user.get_profile.user.username %}</a></strong><br />
		{% if contact.is_friend %}{{ contact.user.first_name}} is your contact.{% endif %}
	</dt>
{% else %}
	<dt id="contact-{{ contact.id }}">
		{% if contact.info.name %}
			<strong class="contact-name">{{ contact.info.name }}</strong><br /><a class="contact-email" href="mailto:{{ contact.info.email }}">{{ contact.info.email }}</a>
		{% else %}
			<strong>&lt;<a class="contact-email" href="mailto:{{ contact.info.email }}">{{ contact.info.email }}</a>&gt;</strong>
		{% endif %}
	</dt>
{% endif %}
	<dd id="contact-details-{{ contact.id }}">
		{% if contact.user %}
			{% if contact.user.get_profile.job %}{% if contact.user.get_profile.job.role %}{{ contact.user.get_profile.job.role }} at {% endif %}{{ contact.user.get_profile.job.name }}<br />{% endif %}
			{% if contact.user.get_profile.country %}{{ contact.user.get_profile.country.name }}<br />{% endif %}
		{% endif %}
		{% if contact.info.address %}{{ contact.info.address }}<br />{% endif %}
		{% if contact.info.phone %}Phone: {{ contact.info.phone }}<br />{% endif %}
		{% if contact.info.mobile %}Mobile: {{ contact.info.mobile }}<br />{% endif %}
		{% if contact.info.fax %}Fax: {{ contact.info.fax }}<br />{% endif %}
		{% if contact.info.website %}Website: <a href="{{ contact.info.website }}">{{ contact.info.website }}</a><br />{% endif %}
		{% if contact.info.type = 'I' %}
			Invitation Sent | 
		{% endif %}
		{% if not contact.user.get_profile and contact.info.type != 'I' %}
			<a id="invite-contact-{{ contact.id }}" class="invite-contact" href="{% url invite_contact contact.id %}">Invite</a> |
		{% else %}
			{% if contact.user and not contact.is_friend %}<a class="invite-friend" href="{% url add_friend contact.user.get_profile.code %}">Invite</a> | {% endif %}
		{% endif %}
		{% if not contact.is_friend %}
			<a class="remove-contact" href="{% url remove_contact contact.user.get_profile.code %}">Invite</a> |
		{% endif %}
		<a href="{% url edit_contact contact.id %}">Edit Details</a>
		{{ expert_profile }}		
	</dd>
{% endfor %}
</dl>
<form method="post" action="" id="contact-form" style="display: none">{% csrf_token %}<fieldset></fieldset></form>
<script type="text/javascript">
	$(document).ready(function (){
		success_function = null;
		function success_invitation_sent(resp) {
			show_message(resp.messages, "Invitation Sent")
		}
		$(".invite-contact").click(function (e){
			$("#contact-form").show().addClass('dialog');
			$("#contact-form fieldset").empty();
			id = $(this).attr('id').replace('invite-contact-','');
			name = $('#contact-'+id+' .contact-name').html();
			email = $('#contact-'+id+' .contact-email').html();
			$("#contact-form").attr('action' , '{% url invite_contact 0 %}'.replace('0', id));
			if (name && name.length) {
				msg = "Send an invitation to " + name + " (" + email + ")";
			} else {
				msg = "Send an invitation email to " + email;
			}
			$("<div>").html(msg).appendTo("#contact-form fieldset");
			$("<label>").html("Message:").append("<br>").append("<textarea name='message' rows='3' cols='40'>").append('<br>').appendTo("#contact-form fieldset");
			$("<input type='submit' value='Send Invitation'>").appendTo('#contact-form fieldset');
			e.stopPropagation();
			return false;
		});
		$(".remove-contact").click(function (e){
			$("#contact-form").show().addClass('dialog');
			$("#contact-form fieldset").empty();
			id = $(this).attr('id').replace('remove-contact-','');
			name = $('#contact-'+id+' .contact-name').html();
			email = $('#contact-'+id+' .contact-email').html();
			$("#contact-form").attr('action' , '{% url remove_contact 0 %}'.replace('0', id));
			if (name && name.length) {
				msg = "Send an invitation to " + name + " (" + email + ")";
			} else {
				msg = "Send an invitation email to " + email;
			}
			$("<div>").html(msg).appendTo("#contact-form fieldset");
			$("<label>").html("Message:").append("<br>").append("<textarea name='message' rows='3' cols='40'>").append('<br>').appendTo("#contact-form fieldset");
			$("<input type='submit' value='Send Invitation'>").appendTo('#contact-form fieldset');
			e.stopPropagation();
			return false;
		});
		$("#contact-form").submit(function (e) {
			e.stopPropagation();
			if (this.action && this.action.length) {
				$.ajax({
					type: "POST",
					url: this.action,
					data: $(this).serialize(),
					success: function(resp) {
						$("#contact-form").hide();
					},
					dataType: 'json'
				});
			}
			return false;
		});
		function show_message(messages, title) {
			$msgbox = $("<div>").addClass('dialog')
			if (title && title.length) {
				$('<h2>').html(title).appendTo(msgbox);
			}
			for (x=0; x < messages.length; x++) {
				$("<div>").html(messages[x]).appendTo(msgbox);
			}
			$closebox=$("<button>").html("Close").click(function (){
				$msgbox.remove();
			}).appendTo(msgBox);
			$msgbox.appendTo(body);
		}
	});
</script>
{% endblock content %}

{% block extra_css %}
	.dialog {
		display: block;
		position: fixed;
		width: 30em;
		height: 15em;
		top: 50%;
		left: 50%;
		margin-top: -7.5em;
		margin-left: -15em;
		background: white;
		border: 3px solid black;
		padding: 1em;
	}
	.dialog h2 {
		text-align: center
	}
	.dialog button {
		margin: 1em auto;
		width: auto;
		display: block;
	}
{% endblock extra_css %}